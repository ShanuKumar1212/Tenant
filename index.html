<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rent Manager</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f5f5f5;
}

/* Tabs */
.tabs {
  display: flex;
  background: #222;
}

.tabs button {
  flex: 1;
  padding: 15px;
  font-size: 16px;
  border: none;
  color: white;
  background: #444;
}

.tabs button.active {
  background: green;
}

/* Content */
.content {
  padding: 10px;
}

/* Cards */
.card {
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
}

.unpaid {
  background: #ffe5e5; /* light red */
}

.paid {
  background: #e6ffe6; /* light green */
}

/* Button */
.pay {
  background: green;
  color: white;
  padding: 10px;
  border: none;
  width: 100%;
  font-size: 16px;
  border-radius: 5px;
}

.pay:disabled {
  background: gray;
}

/* History list */
.item {
  padding: 15px;
  border-bottom: 1px solid #ddd;
  font-size: 18px;
  background: white;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- Tabs -->
<div class="tabs">
  <button id="tabPay" class="active" onclick="showPay()">MARK PAID</button>
  <button id="tabHistory" onclick="showHistory()">HISTORY</button>
</div>

<div id="content" class="content"></div>

<script>
/* üî¥ MUST BE APPS SCRIPT WEB APP URL */
const API = "https://script.google.com/macros/s/AKfycbzBD8tBuor2JEJy3JHoe0Me87stRuwXJZIWvVgPyUxCnajFd9x7Wq1ZX-ZOMQpfSwId/exec";

let tenants = [];

/* ================= LOAD TENANTS ================= */
fetch(API)
  .then(res => res.json())
  .then(data => {
    tenants = data;
    showPay();
  })
  .catch(() => {
    document.getElementById("content").innerHTML =
      "<p>‚ùå Unable to load data</p>";
  });

/* ================= TAB SWITCH ================= */
function setActive(id) {
  document.getElementById("tabPay").classList.remove("active");
  document.getElementById("tabHistory").classList.remove("active");
  document.getElementById(id).classList.add("active");
}

/* ================= MARK PAID TAB ================= */
function showPay() {
  setActive("tabPay");
  let html = "";

  tenants.forEach(t => {
    if (t[4] !== "PAID") {
      html += `
        <div class="card unpaid">
          <b>Room:</b> ${t[0]}<br>
          <b>Name:</b> ${t[1]}<br>
          <b>Rent:</b> ‚Çπ${t[2]}<br>
          <b>Due:</b> ${t[3]}<br><br>

          <button class="pay" id="btn-${t[0]}" onclick="pay('${t[0]}')">
            MARK PAID
          </button>
        </div>
      `;
    }
  });

  document.getElementById("content").innerHTML =
    html || "<b>‚úÖ All rents paid</b>";
}

/* ================= HISTORY TAB ================= */
function showHistory() {
  setActive("tabHistory");
  let html = "<h3>Select Tenant</h3>";

  tenants.forEach(t => {
    html += `
      <div class="item" onclick="openHistory('${t[0]}','${t[1]}')">
        Room ${t[0]} - ${t[1]}
      </div>
    `;
  });

  document.getElementById("content").innerHTML = html;
}

/* ================= MARK PAID ACTION ================= */
function pay(room) {
  if (!confirm("Confirm rent received?")) return;

  const btn = document.getElementById("btn-" + room);
  if (btn) {
    btn.disabled = true;
    btn.innerText = "PAID";
  }

  fetch(API, {
    method: "POST",
    body: new URLSearchParams({ room })
  }).then(() => {
    tenants = tenants.map(t => {
      if (t[0] == room) t[4] = "PAID";
      return t;
    });
  });
}

/* ================= VIEW HISTORY (PAID ONLY) ================= */
function openHistory(room, name) {
  fetch(API + "?room=" + encodeURIComponent(room))
    .then(res => res.text())
    .then(text => {

      // DEBUG safety: show error if backend fails
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        document.getElementById("content").innerHTML =
          "<h3>History Error</h3><pre>" + text + "</pre>";
        return;
      }

      let html = `<h3>üìú ${name} (Room ${room})</h3>`;

      if (!Array.isArray(data) || data.length === 0) {
        html += `<div class="card unpaid">‚ùå No rent payment recorded yet.</div>`;
      } else {
        data.forEach(h => {
          html += `
            <div class="card paid">
              <b>Month:</b> ${h[2]}<br>
              <b>Amount:</b> ‚Çπ${h[3]}<br>
              <b>Paid Date:</b> ${new Date(h[4]).toDateString()}
            </div>
          `;
        });
      }

      html += `<button onclick="showHistory()">‚¨Ö BACK</button>`;
      document.getElementById("content").innerHTML = html;
    })
    .catch(err => {
      document.getElementById("content").innerHTML =
        "<p>‚ùå Failed to load history</p><pre>" + err + "</pre>";
    });
}
</script>

</body>
</html>
